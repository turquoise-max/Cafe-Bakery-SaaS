{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Proj/cafe-bakery-saas/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { cookies } from 'next/headers'\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options)\n            )\n          } catch {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,0IAAO;IAEjC,OAAO,IAAA,+LAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 36, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Proj/cafe-bakery-saas/src/app/dashboard/inventory/actions.ts"],"sourcesContent":["\"use server\";\n\nimport { createClient } from \"@/lib/supabase/server\";\nimport { InventoryItem } from \"@/types/inventory\";\nimport { revalidatePath } from \"next/cache\";\nimport { redirect } from \"next/navigation\";\n\nexport interface InventoryDashboardItem extends InventoryItem {\n  isLowStock: boolean;\n}\n\nexport async function getInventoryDashboardData(): Promise<InventoryDashboardItem[]> {\n  const supabase = await createClient();\n  \n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) throw new Error(\"Unauthorized\");\n\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) {\n    // redirect(\"/onboarding\");\n    return []; // Return empty data instead of redirecting\n  }\n\n  const { data, error } = await supabase\n    .from(\"inventory\")\n    .select(`\n      *,\n      item:items (\n        id,\n        name,\n        code,\n        type,\n        base_unit,\n        safety_stock,\n        latest_purchase_price,\n        category:categories (\n          name\n        )\n      )\n    `)\n    .eq(\"store_id\", userRole.store_id)\n    .order(\"variance\", { ascending: true });\n\n  if (error) {\n    console.error(\"Error fetching inventory:\", error);\n    throw new Error(\"Failed to fetch inventory\");\n  }\n\n  // Transform data to include low stock logic\n  const dashboardData: InventoryDashboardItem[] = (data as any[]).map((row) => {\n    const safetyStock = row.item.safety_stock || 0;\n    const currentStock = row.theoretical_quantity || 0;\n    // Logic: Is current stock less than safety stock?\n    // Only if safety stock is set (> 0) and inventory is managed\n    const isLowStock = safetyStock > 0 && currentStock < safetyStock;\n\n    return {\n      ...row,\n      isLowStock\n    };\n  });\n  \n  return dashboardData;\n}\n\nexport async function getInventory() {\n  const supabase = await createClient();\n  \n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) throw new Error(\"Unauthorized\");\n\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) {\n    // redirect(\"/onboarding\");\n    return []; // Return empty data instead of redirecting\n  }\n\n  const { data, error } = await supabase\n    .from(\"inventory\")\n    .select(`\n      *,\n      item:items (\n        id,\n        name,\n        code,\n        type,\n        base_unit,\n        safety_stock,\n        latest_purchase_price,\n        category:categories (\n          name\n        )\n      )\n    `)\n    .eq(\"store_id\", userRole.store_id)\n    .order(\"variance\", { ascending: true });\n\n  if (error) {\n    console.error(\"Error fetching inventory:\", error);\n    throw new Error(\"Failed to fetch inventory\");\n  }\n  \n  return data as unknown as InventoryItem[];\n}\n\nexport async function getSuppliers() {\n  const supabase = await createClient();\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) return [];\n\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) return [];\n\n  const { data } = await supabase\n    .from(\"suppliers\")\n    .select(\"*\")\n    .eq(\"store_id\", userRole.store_id)\n    .eq(\"is_active\", true)\n    .order(\"name\");\n\n  return data || [];\n}\n\nexport async function getUserStore() {\n  const supabase = await createClient();\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) return null;\n\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  return userRole?.store_id || null;\n}\n\ninterface InboundItem {\n  itemId: string;\n  quantity: number;\n  unitPrice: number;\n  expiryDate?: string;\n}\n\nexport async function processInbound(supplierId: string | null, items: InboundItem[]) {\n  const supabase = await createClient();\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) return { error: \"Unauthorized\" };\n\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) return { error: \"Store not found\" };\n  const storeId = userRole.store_id;\n\n  // 1. Create Purchase Order (Draft -> Received)\n  // For Direct Inbound, we assume it's received immediately.\n  const { data: po, error: poError } = await supabase\n    .from(\"purchase_orders\")\n    .insert({\n      store_id: storeId,\n      supplier_id: supplierId,\n      status: \"received\", // Direct receive\n      order_date: new Date().toISOString(),\n      received_date: new Date().toISOString(),\n      created_by: user.id,\n      total_amount: items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0)\n    })\n    .select()\n    .single();\n\n  if (poError) return { error: `Failed to create PO: ${poError.message}` };\n\n  for (const item of items) {\n    // A. Insert PO Item\n    // We fetch item unit first\n    const { data: itemData } = await supabase\n      .from(\"items\")\n      .select(\"base_unit, latest_purchase_price\")\n      .eq(\"id\", item.itemId)\n      .single();\n      \n    if (!itemData) continue;\n\n    const { data: poItem, error: poItemError } = await supabase\n      .from(\"purchase_order_items\")\n      .insert({\n        purchase_order_id: po.id,\n        item_id: item.itemId,\n        ordered_quantity: item.quantity,\n        received_quantity: item.quantity, // Full receive\n        unit: itemData.base_unit, // Assume input matches base unit for now\n        unit_price: item.unitPrice,\n        expiry_date: item.expiryDate\n      })\n      .select()\n      .single();\n\n    if (poItemError || !poItem) {\n      console.error(\"Failed to insert PO Item:\", poItemError);\n      continue;\n    }\n\n    // B. Update Inventory & Record Transaction\n    // This is now handled by the 'trg_purchase_receipt_inventory' trigger\n    // when we insert into 'purchase_order_items'.\n\n    // C. Create Inventory Lot (FIFO)\n    // Generate a simple lot number: LOT-{YYYYMMDD}-{Random}\n    const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, \"\");\n    const randomStr = Math.random().toString(36).substring(2, 7).toUpperCase();\n    const lotNumber = `LOT-${dateStr}-${randomStr}`;\n\n    await supabase.from(\"inventory_lots\").insert({\n      store_id: storeId,\n      item_id: item.itemId,\n      lot_number: lotNumber,\n      quantity: item.quantity,\n      remaining_quantity: item.quantity,\n      unit: itemData.base_unit,\n      received_date: new Date().toISOString(), // received today\n      expiry_date: item.expiryDate || null,\n      unit_cost: item.unitPrice,\n      purchase_order_item_id: poItem.id\n    });\n\n    // E. Update Latest Purchase Price if changed\n    if (item.unitPrice !== itemData.latest_purchase_price) {\n      await supabase\n        .from(\"items\")\n        .update({ latest_purchase_price: item.unitPrice })\n        .eq(\"id\", item.itemId);\n    }\n  }\n\n  revalidatePath(\"/dashboard/inventory\");\n  return { success: true };\n}\n\nexport async function updatePhysicalCount(\n  itemId: string,\n  physicalQuantity: number,\n  reason: string,\n  notes?: string\n) {\n  const supabase = await createClient();\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) return { error: \"Unauthorized\" };\n\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) return { error: \"Store not found\" };\n  const storeId = userRole.store_id;\n\n  try {\n    // 1. Start Physical Count (Spot Check)\n    const { data: countId, error: startError } = await supabase.rpc('start_physical_count', {\n      p_store_id: storeId,\n      p_count_date: new Date().toISOString(),\n      p_zone: 'Quick Adjustment', // Default zone for quick adjustments\n      p_user_id: user.id\n    });\n\n    if (startError) throw new Error(`Failed to start physical count: ${startError.message}`);\n\n    // 2. Record Item Count\n    // Fetch item unit first\n    const { data: itemData } = await supabase\n      .from(\"items\")\n      .select(\"base_unit\")\n      .eq(\"id\", itemId)\n      .single();\n\n    const { error: recordError } = await supabase.rpc('record_count_item', {\n      p_count_id: countId,\n      p_item_id: itemId,\n      p_counted_quantity: physicalQuantity,\n      p_unit: itemData?.base_unit || \"ea\",\n      p_notes: `${reason} ${notes ? `- ${notes}` : \"\"}`\n    });\n\n    if (recordError) throw new Error(`Failed to record item count: ${recordError.message}`);\n\n    // 3. Complete Physical Count (This triggers inventory update & transaction logging)\n    const { error: completeError } = await supabase.rpc('complete_physical_count', {\n      p_count_id: countId\n    });\n\n    if (completeError) throw new Error(`Failed to complete physical count: ${completeError.message}`);\n\n    revalidatePath(\"/dashboard/inventory\");\n    return { success: true };\n  } catch (error: any) {\n    console.error(\"Error updating physical count:\", error);\n    return { error: error.message };\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 290, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Proj/cafe-bakery-saas/src/app/dashboard/items/actions.ts"],"sourcesContent":["\"use server\";\n\nimport { createClient } from \"@/lib/supabase/server\";\nimport { Item, ItemType, UnitType } from \"@/types/inventory\";\nimport { revalidatePath } from \"next/cache\";\nimport { redirect } from \"next/navigation\";\n\nexport type CreateItemInput = {\n  name: string;\n  code?: string;\n  type: ItemType;\n  base_unit: UnitType;\n  safety_stock?: number;\n  category_id?: string;\n};\n\nexport async function getItems() {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) {\n    throw new Error(\"Unauthorized\");\n  }\n\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) {\n    // redirect(\"/onboarding\");\n    return []; // Return empty items if no store\n  }\n\n  const { data, error } = await supabase\n    .from(\"items\")\n    .select(`\n      *,\n      category:categories(name)\n    `)\n    .eq(\"store_id\", userRole.store_id)\n    .order(\"name\");\n\n  if (error) {\n    console.error(\"Error fetching items:\", error);\n    throw new Error(\"Failed to fetch items\");\n  }\n\n  return data as Item[];\n}\n\nexport async function createItem(input: CreateItemInput) {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) {\n    return { error: \"Unauthorized\" };\n  }\n\n  // Get Store ID (Strict Check)\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) {\n    return { error: \"Store not found for user\" };\n  }\n\n  const { data, error } = await supabase\n    .from(\"items\")\n    .insert({\n      store_id: userRole.store_id,\n      name: input.name,\n      code: input.code,\n      type: input.type,\n      base_unit: input.base_unit,\n      safety_stock: input.safety_stock, // Supabase handles number -> decimal\n      category_id: input.category_id,\n      is_active: true,\n    })\n    .select()\n    .single();\n\n  if (error) {\n    console.error(\"Error creating item:\", error);\n    return { error: `Failed to create item: ${error.message}` };\n  }\n\n  revalidatePath(\"/dashboard/items\");\n  return { success: true, item: data };\n}\n\nexport async function deleteItem(itemId: string) {\n  const supabase = await createClient();\n  \n  const { error } = await supabase\n    .from(\"items\")\n    .delete()\n    .eq(\"id\", itemId);\n\n  if (error) {\n    return { error: error.message };\n  }\n\n  revalidatePath(\"/dashboard/items\");\n  return { success: true };\n}"],"names":[],"mappings":";;;;;;;;;AAEA;AAEA;;;;;AAYO,eAAe;IACpB,MAAM,WAAW,MAAM,IAAA,gJAAY;IACnC,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAE/B,IAAI,CAAC,MAAM;QACT,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,cACL,MAAM,CAAC,YACP,EAAE,CAAC,WAAW,KAAK,EAAE,EACrB,MAAM;IAET,IAAI,CAAC,UAAU,UAAU;QACvB,2BAA2B;QAC3B,OAAO,EAAE,EAAE,iCAAiC;IAC9C;IAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,SACL,MAAM,CAAC,CAAC;;;IAGT,CAAC,EACA,EAAE,CAAC,YAAY,SAAS,QAAQ,EAChC,KAAK,CAAC;IAET,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO;AACT;AAEO,eAAe,WAAW,KAAsB;IACrD,MAAM,WAAW,MAAM,IAAA,gJAAY;IACnC,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAE/B,IAAI,CAAC,MAAM;QACT,OAAO;YAAE,OAAO;QAAe;IACjC;IAEA,8BAA8B;IAC9B,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,cACL,MAAM,CAAC,YACP,EAAE,CAAC,WAAW,KAAK,EAAE,EACrB,MAAM;IAET,IAAI,CAAC,UAAU,UAAU;QACvB,OAAO;YAAE,OAAO;QAA2B;IAC7C;IAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,SACL,MAAM,CAAC;QACN,UAAU,SAAS,QAAQ;QAC3B,MAAM,MAAM,IAAI;QAChB,MAAM,MAAM,IAAI;QAChB,MAAM,MAAM,IAAI;QAChB,WAAW,MAAM,SAAS;QAC1B,cAAc,MAAM,YAAY;QAChC,aAAa,MAAM,WAAW;QAC9B,WAAW;IACb,GACC,MAAM,GACN,MAAM;IAET,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO;YAAE,OAAO,CAAC,uBAAuB,EAAE,MAAM,OAAO,EAAE;QAAC;IAC5D;IAEA,IAAA,+IAAc,EAAC;IACf,OAAO;QAAE,SAAS;QAAM,MAAM;IAAK;AACrC;AAEO,eAAe,WAAW,MAAc;IAC7C,MAAM,WAAW,MAAM,IAAA,gJAAY;IAEnC,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,SACL,MAAM,GACN,EAAE,CAAC,MAAM;IAEZ,IAAI,OAAO;QACT,OAAO;YAAE,OAAO,MAAM,OAAO;QAAC;IAChC;IAEA,IAAA,+IAAc,EAAC;IACf,OAAO;QAAE,SAAS;IAAK;AACzB;;;IAjGsB;IAsCA;IA6CA;;AAnFA,+OAAA;AAsCA,+OAAA;AA6CA,+OAAA"}},
    {"offset": {"line": 389, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Proj/cafe-bakery-saas/src/app/dashboard/inventory/sales-actions.ts"],"sourcesContent":["'use server'\n\nimport { createClient } from '@/lib/supabase/server'\nimport { revalidatePath } from 'next/cache'\n\ninterface SaleItemInput {\n  itemId: string\n  quantity: number\n}\n\nexport async function getSaleItems() {\n  const supabase = await createClient()\n  \n  const { data: { user } } = await supabase.auth.getUser()\n  if (!user) return []\n\n  // Get user's store\n  const { data: userRole } = await supabase\n    .from('user_roles')\n    .select('store_id')\n    .eq('user_id', user.id)\n    .single()\n\n  if (!userRole?.store_id) return []\n\n  const { data, error } = await supabase\n    .from('items')\n    .select('id, name, sale_price, base_unit')\n    .eq('store_id', userRole.store_id)\n    .eq('type', 'finished') // Only finished goods can be sold\n    .order('name')\n\n  if (error) {\n    console.error('Error fetching sale items:', error)\n    return []\n  }\n\n  return data\n}\n\nexport async function recordSale(storeId: string, items: SaleItemInput[]) {\n  const supabase = await createClient()\n\n  try {\n    // 1. Create Sale Record\n    const { data: saleData, error: saleError } = await supabase\n      .from('sales')\n      .insert({\n        store_id: storeId,\n        sale_date: new Date().toISOString().split('T')[0], // Today\n        sale_time: new Date().toTimeString().split(' ')[0], // Current time\n        channel: 'pos', // Default to POS for simulator\n        total_amount: 0, // We don't calculate price in simulator for now\n      })\n      .select()\n      .single()\n\n    if (saleError) throw saleError\n\n    // 2. Create Sale Items\n    const saleItems = items.map((item) => ({\n      sale_id: saleData.id,\n      item_id: item.itemId,\n      quantity: item.quantity,\n    }))\n\n    const { error: itemsError } = await supabase\n      .from('sales_items')\n      .insert(saleItems)\n\n    if (itemsError) throw itemsError\n\n    // 3. Process Inventory Deduction (Application Layer Logic instead of DB Trigger)\n    // This replaces the trigger 'trg_sale_inventory_deduction' from migration 20240101000008\n    await processSaleInventory(supabase, storeId, saleData.id, items)\n\n    // 4. Revalidate Inventory Page to reflect changes\n    revalidatePath('/dashboard/inventory')\n\n    return { success: true, message: '판매가 성공적으로 기록되었습니다.' }\n  } catch (error: any) {\n    console.error('Error recording sale:', error)\n    return { success: false, message: error.message || '판매 기록 중 오류가 발생했습니다.' }\n  }\n}\n\n// Helper to process inventory deduction (Simulates the DB Trigger logic)\nasync function processSaleInventory(supabase: any, storeId: string, saleId: string, items: SaleItemInput[]) {\n  for (const item of items) {\n    // Get the product name for logging\n    const { data: product } = await supabase\n      .from('items')\n      .select('name')\n      .eq('id', item.itemId)\n      .single()\n    \n    const productName = product?.name || 'Unknown Product'\n\n    // A. Check for Recipe (BOM)\n    // We look for an active recipe for this output item\n    const { data: recipe } = await supabase\n      .from('recipes')\n      .select('id, output_quantity')\n      .eq('output_item_id', item.itemId)\n      .eq('is_active', true)\n      .maybeSingle() // Use maybeSingle to avoid error if no recipe\n\n    if (recipe) {\n      // Has Recipe: Deduct Ingredients\n      const { data: ingredients } = await supabase\n        .from('recipe_items')\n        .select('input_item_id, quantity, unit')\n        .eq('recipe_id', recipe.id)\n\n      if (ingredients && ingredients.length > 0) {\n        for (const ing of ingredients) {\n          // Calculate required quantity: (Ingredient Qty * Sold Qty) / Recipe Output Qty\n          // Example: Recipe makes 1 Cake using 500g Flour. Sold 2 Cakes. Need (500 * 2) / 1 = 1000g Flour.\n          const deductionQty = (ing.quantity * item.quantity) / recipe.output_quantity\n\n          // Update Inventory for the ingredient\n          await updateInventory(\n            supabase, \n            storeId, \n            ing.input_item_id, \n            deductionQty, \n            ing.unit, \n            saleId, \n            'sale',\n            `Sale of ${productName} (Qty: ${item.quantity}) - Ingredient Deduction`\n          )\n        }\n      }\n    } else {\n      // No Recipe: Deduct Item Itself (e.g. bottled drink, or simple item)\n      // Check if it's inventory managed\n      const { data: itemInfo } = await supabase\n        .from('items')\n        .select('is_inventory_managed, base_unit')\n        .eq('id', item.itemId)\n        .single()\n      \n      if (itemInfo && itemInfo.is_inventory_managed) {\n        await updateInventory(\n          supabase, \n          storeId, \n          item.itemId, \n          item.quantity, \n          itemInfo.base_unit, \n          saleId, \n          'sale',\n          `Sale of ${productName} (Qty: ${item.quantity}) - Direct Deduction`\n        )\n      }\n    }\n  }\n}\n\n// Helper to update inventory and record transaction\nasync function updateInventory(\n  supabase: any, \n  storeId: string, \n  itemId: string, \n  quantity: number, \n  unit: string, \n  referenceId: string,\n  type: 'sale' | 'purchase' | 'adjustment' | 'waste' | 'production' | 'transfer',\n  notes: string\n) {\n  // 1. Update Inventory Table\n  // We need to fetch current quantity first to update it\n  const { data: inventory } = await supabase\n    .from('inventory')\n    .select('id, theoretical_quantity')\n    .eq('store_id', storeId)\n    .eq('item_id', itemId)\n    .maybeSingle()\n\n  if (inventory) {\n    const newQty = inventory.theoretical_quantity - quantity // Decrement\n    \n    await supabase\n      .from('inventory')\n      .update({ \n        theoretical_quantity: newQty,\n        last_updated_at: new Date().toISOString() \n      })\n      .eq('id', inventory.id)\n  } else {\n    // Create new inventory record if not exists (starts at negative quantity)\n    // This happens if we sell something we haven't officially \"stocked\" yet\n    await supabase\n      .from('inventory')\n      .insert({\n        store_id: storeId,\n        item_id: itemId,\n        theoretical_quantity: -quantity,\n        physical_quantity: 0\n      })\n  }\n\n  // 2. Insert Transaction Record\n  await supabase\n    .from('inventory_transactions')\n    .insert({\n      store_id: storeId,\n      item_id: itemId,\n      transaction_type: type,\n      quantity: -quantity, // Negative for deduction\n      unit: unit,\n      reference_type: 'sale',\n      reference_id: referenceId,\n      transaction_date: new Date().toISOString().split('T')[0],\n      notes: notes\n    })\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 532, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Proj/cafe-bakery-saas/.next-internal/server/app/dashboard/inventory/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getInventory as '00242ed99168f557f2d608515fd4bc4d8d5a963d36'} from 'ACTIONS_MODULE0'\nexport {getSuppliers as '009f2ebd9f5e18aad71d29da313f09fed9ae95f989'} from 'ACTIONS_MODULE0'\nexport {getInventoryDashboardData as '00bb8966836fbbee06790a23414d97dde961210d3d'} from 'ACTIONS_MODULE0'\nexport {getUserStore as '00e728ad3578f4e2696299621d6c1de70da01a2e1b'} from 'ACTIONS_MODULE0'\nexport {processInbound as '600976a9b4d8df6da1d5db027a73855bb18c382110'} from 'ACTIONS_MODULE0'\nexport {updatePhysicalCount as '7875fdec04f22c52a785766e014bee004ad149675d'} from 'ACTIONS_MODULE0'\nexport {getItems as '001aea836daf26be9195c23c5625652d6dbba4322f'} from 'ACTIONS_MODULE1'\nexport {deleteItem as '402f3cfe50d32bb556d90c95dc56e19679ab92f2c2'} from 'ACTIONS_MODULE1'\nexport {createItem as '40e564b33b2354f68726dd75c1c6eb83c39fdb0f17'} from 'ACTIONS_MODULE1'\nexport {processInbound as '600976a9b4d8df6da1d5db027a73855bb18c382110'} from 'ACTIONS_MODULE0'\nexport {getSaleItems as '004579005769e38fabb568dcfde8edc6bf2ce8583b'} from 'ACTIONS_MODULE2'\nexport {recordSale as '60007e8c3887fc2cf8c927f297d6e6d8c61297d8c0'} from 'ACTIONS_MODULE2'\nexport {getUserStore as '00e728ad3578f4e2696299621d6c1de70da01a2e1b'} from 'ACTIONS_MODULE0'\nexport {updatePhysicalCount as '7875fdec04f22c52a785766e014bee004ad149675d'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA;AAMA;AAIA"}}]
}