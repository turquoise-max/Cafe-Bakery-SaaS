{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Proj/cafe-bakery-saas/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { cookies } from 'next/headers'\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options)\n            )\n          } catch {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,0IAAO;IAEjC,OAAO,IAAA,+LAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 36, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Proj/cafe-bakery-saas/src/app/dashboard/recipes/actions.ts"],"sourcesContent":["\"use server\";\n\nimport { createClient } from \"@/lib/supabase/server\";\nimport { revalidatePath } from \"next/cache\";\n\ninterface RecipeItemInput {\n  inputItemId: string;\n  quantity: number;\n  unit: string;\n}\n\ninterface CreateRecipeInput {\n  outputItemId: string;\n  outputQuantity: number;\n  items: RecipeItemInput[];\n  name?: string;\n  description?: string;\n}\n\nexport async function createRecipe(data: CreateRecipeInput) {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) {\n    return { error: \"Unauthorized\" };\n  }\n\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) {\n    return { error: \"Store not found\" };\n  }\n\n  const store_id = userRole.store_id;\n  const { outputItemId, outputQuantity, items, name, description } = data;\n\n  // Validation: Circular Reference Check\n  if (items.some((item) => item.inputItemId === outputItemId)) {\n    return { error: \"Self-reference detected: Output item cannot be an ingredient.\" };\n  }\n\n  // 1. Calculate next version\n  const { data: existingRecipes, error: versionError } = await supabase\n    .from(\"recipes\")\n    .select(\"version\")\n    .eq(\"store_id\", store_id)\n    .eq(\"output_item_id\", outputItemId)\n    .order(\"version\", { ascending: false })\n    .limit(1);\n\n  if (versionError) {\n    return { error: `Version check failed: ${versionError.message}` };\n  }\n\n  const nextVersion = existingRecipes && existingRecipes.length > 0\n    ? existingRecipes[0].version + 1\n    : 1;\n\n  // 2. Insert Recipe\n  const { data: recipe, error: recipeError } = await supabase\n    .from(\"recipes\")\n    .insert({\n      store_id,\n      output_item_id: outputItemId,\n      output_quantity: outputQuantity,\n      version: nextVersion,\n      is_active: true,\n      name,\n      description,\n    })\n    .select()\n    .single();\n\n  if (recipeError) {\n    return { error: `Recipe creation failed: ${recipeError.message}` };\n  }\n\n  // 3. Insert Recipe Items\n  if (items.length > 0) {\n    const recipeItems = items.map((item, index) => ({\n      recipe_id: recipe.id,\n      input_item_id: item.inputItemId,\n      quantity: item.quantity,\n      unit: item.unit,\n      sort_order: index,\n    }));\n\n    const { error: itemsError } = await supabase\n      .from(\"recipe_items\")\n      .insert(recipeItems);\n\n    if (itemsError) {\n      // Rollback: delete the recipe if items fail\n      await supabase.from(\"recipes\").delete().eq(\"id\", recipe.id);\n      return { error: `Failed to add ingredients: ${itemsError.message}` };\n    }\n  }\n\n  // 4. Deactivate previous versions\n  const { error: deactivateError } = await supabase\n    .from(\"recipes\")\n    .update({ is_active: false })\n    .eq(\"store_id\", store_id)\n    .eq(\"output_item_id\", outputItemId)\n    .neq(\"id\", recipe.id); // Exclude the new one\n\n  if (deactivateError) {\n    console.error(\"Failed to deactivate old recipes:\", deactivateError);\n  }\n\n  revalidatePath(\"/dashboard/recipes\");\n  return { success: true, recipeId: recipe.id };\n}\n\nexport async function calculateRecipeCost(items: RecipeItemInput[]) {\n  const supabase = await createClient();\n  let totalCost = 0;\n\n  // Fetch prices for all items\n  const itemIds = items.map((i) => i.inputItemId);\n  const { data: dbItems } = await supabase\n    .from(\"items\")\n    .select(\"id, base_unit, latest_purchase_price\")\n    .in(\"id\", itemIds);\n\n  if (!dbItems) return 0;\n\n  for (const item of items) {\n    const dbItem = dbItems.find((i) => i.id === item.inputItemId);\n    if (!dbItem || !dbItem.latest_purchase_price) continue;\n\n    // Convert unit\n    // We call the DB function for accurate conversion\n    const { data: convertedQty } = await supabase.rpc(\"convert_unit\", {\n      p_quantity: item.quantity,\n      p_from_unit: item.unit,\n      p_to_unit: dbItem.base_unit,\n      p_item_id: item.inputItemId\n    });\n\n    if (convertedQty !== null) {\n      totalCost += (convertedQty as number) * dbItem.latest_purchase_price;\n    }\n  }\n\n  return totalCost;\n}\n\nexport async function getRecipes() {\n  const supabase = await createClient();\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) return [];\n\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) return [];\n\n  const { data } = await supabase\n    .from(\"recipes\")\n    .select(`\n      *,\n      output_item:items!output_item_id(name, code, base_unit),\n      recipe_items(\n        quantity,\n        unit,\n        input_item:items!input_item_id(name, base_unit, latest_purchase_price)\n      )\n    `)\n    .eq(\"store_id\", userRole.store_id)\n    .eq(\"is_active\", true)\n    .order(\"created_at\", { ascending: false });\n\n  return data || [];\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 185, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Proj/cafe-bakery-saas/.next-internal/server/app/dashboard/recipes/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getRecipes as '0067871440310bd5f6dfcc08c319de2d658e6f355b'} from 'ACTIONS_MODULE0'\nexport {calculateRecipeCost as '402d0609eb37447a75537aeca8f2fe0f2a3b08c2ff'} from 'ACTIONS_MODULE0'\nexport {createRecipe as '40e29492683456c20143c4d0a53e8d770bacec6584'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}