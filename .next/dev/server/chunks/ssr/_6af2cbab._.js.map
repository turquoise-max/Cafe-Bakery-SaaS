{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Proj/cafe-bakery-saas/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { cookies } from 'next/headers'\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options)\n            )\n          } catch {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,0IAAO;IAEjC,OAAO,IAAA,+LAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 36, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Proj/cafe-bakery-saas/src/app/dashboard/inventory/actions.ts"],"sourcesContent":["\"use server\";\n\nimport { createClient } from \"@/lib/supabase/server\";\nimport { InventoryItem } from \"@/types/inventory\";\nimport { revalidatePath } from \"next/cache\";\n\nexport async function getInventory() {\n  const supabase = await createClient();\n  \n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) throw new Error(\"Unauthorized\");\n\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) throw new Error(\"Store not found\");\n\n  const { data, error } = await supabase\n    .from(\"inventory\")\n    .select(`\n      *,\n      item:items (\n        id,\n        name,\n        code,\n        type,\n        base_unit,\n        safety_stock,\n        latest_purchase_price,\n        category:categories (\n          name\n        )\n      )\n    `)\n    .eq(\"store_id\", userRole.store_id)\n    .order(\"variance\", { ascending: true });\n\n  if (error) {\n    console.error(\"Error fetching inventory:\", error);\n    throw new Error(\"Failed to fetch inventory\");\n  }\n  \n  return data as unknown as InventoryItem[];\n}\n\nexport async function getSuppliers() {\n  const supabase = await createClient();\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) return [];\n\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) return [];\n\n  const { data } = await supabase\n    .from(\"suppliers\")\n    .select(\"*\")\n    .eq(\"store_id\", userRole.store_id)\n    .eq(\"is_active\", true)\n    .order(\"name\");\n\n  return data || [];\n}\n\ninterface InboundItem {\n  itemId: string;\n  quantity: number;\n  unitPrice: number;\n  expiryDate?: string;\n}\n\nexport async function processInbound(supplierId: string | null, items: InboundItem[]) {\n  const supabase = await createClient();\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) return { error: \"Unauthorized\" };\n\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) return { error: \"Store not found\" };\n  const storeId = userRole.store_id;\n\n  // 1. Create Purchase Order (Draft -> Received)\n  // For Direct Inbound, we assume it's received immediately.\n  const { data: po, error: poError } = await supabase\n    .from(\"purchase_orders\")\n    .insert({\n      store_id: storeId,\n      supplier_id: supplierId,\n      status: \"received\", // Direct receive\n      order_date: new Date().toISOString(),\n      received_date: new Date().toISOString(),\n      created_by: user.id,\n      total_amount: items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0)\n    })\n    .select()\n    .single();\n\n  if (poError) return { error: `Failed to create PO: ${poError.message}` };\n\n  // 2. Insert Items\n  // Note: The DB trigger 'trg_purchase_receipt_inventory' listens to UPDATE of received_quantity.\n  // To trigger it, we might need to Insert 0 then Update? \n  // OR we can manually update inventory here.\n  // Given we control the Action, Manual Update + Transaction Log is more explicit and robust for \"Direct Inbound\" feature.\n  // The Trigger is good for \"PO Workflow\" (Order -> Wait -> Receive).\n  // Let's do manual update to ensure 'latest_purchase_price' update logic is handled.\n\n  for (const item of items) {\n    // A. Insert PO Item\n    // We fetch item unit first\n    const { data: itemData } = await supabase\n      .from(\"items\")\n      .select(\"base_unit, latest_purchase_price\")\n      .eq(\"id\", item.itemId)\n      .single();\n      \n    if (!itemData) continue;\n\n    await supabase.from(\"purchase_order_items\").insert({\n      purchase_order_id: po.id,\n      item_id: item.itemId,\n      ordered_quantity: item.quantity,\n      received_quantity: item.quantity, // Full receive\n      unit: itemData.base_unit, // Assume input matches base unit for now\n      unit_price: item.unitPrice,\n      expiry_date: item.expiryDate\n    });\n\n    // B. Update Inventory (Increment)\n    // We use the 'deduct_inventory_smart' logic reversed? No, simple increment.\n    // But we should use a DB function if possible to ensure consistency.\n    // Let's manually update for now as we don't have 'add_inventory' function.\n    \n    // Check if inventory record exists\n    const { data: inv } = await supabase\n      .from(\"inventory\")\n      .select(\"id, theoretical_quantity\")\n      .eq(\"store_id\", storeId)\n      .eq(\"item_id\", item.itemId)\n      .single();\n\n    if (inv) {\n      await supabase\n        .from(\"inventory\")\n        .update({ \n          theoretical_quantity: inv.theoretical_quantity + item.quantity,\n          last_updated_at: new Date().toISOString()\n        })\n        .eq(\"id\", inv.id);\n    } else {\n      await supabase\n        .from(\"inventory\")\n        .insert({\n          store_id: storeId,\n          item_id: item.itemId,\n          theoretical_quantity: item.quantity\n        });\n    }\n\n    // C. Record Transaction\n    await supabase.from(\"inventory_transactions\").insert({\n      store_id: storeId,\n      item_id: item.itemId,\n      transaction_type: \"purchase\",\n      quantity: item.quantity, // Positive for inbound\n      unit: itemData.base_unit,\n      unit_cost: item.unitPrice,\n      total_cost: item.quantity * item.unitPrice,\n      reference_type: \"purchase_order\",\n      reference_id: po.id,\n      transaction_date: new Date().toISOString(),\n      created_by: user.id\n    });\n\n    // D. Update Latest Purchase Price if changed\n    if (item.unitPrice !== itemData.latest_purchase_price) {\n      // Logic: Always update to latest? Or ask user? \n      // Requirement says \"consider logic\". For MVP \"Direct Inbound\", updating is standard.\n      await supabase\n        .from(\"items\")\n        .update({ latest_purchase_price: item.unitPrice })\n        .eq(\"id\", item.itemId);\n    }\n  }\n\n  revalidatePath(\"/dashboard/inventory\");\n  return { success: true };\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 194, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Proj/cafe-bakery-saas/src/app/dashboard/items/actions.ts"],"sourcesContent":["\"use server\";\n\nimport { createClient } from \"@/lib/supabase/server\";\nimport { Item, ItemType, UnitType } from \"@/types/inventory\";\nimport { revalidatePath } from \"next/cache\";\n\nexport type CreateItemInput = {\n  name: string;\n  code?: string;\n  type: ItemType;\n  base_unit: UnitType;\n  safety_stock?: number;\n  category_id?: string;\n};\n\nexport async function getItems() {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) {\n    throw new Error(\"Unauthorized\");\n  }\n\n  // RLS will filter by store_id, but we need to ensure user has a role\n  // Actually RLS policy uses `auth.uid()`, so we just need to be authenticated.\n  // But strictly, we should check if they are attached to a store.\n  // The 'sync_user_role_to_metadata' trigger optimization would allow us to use metadata.\n  // For now, let's trust RLS but handle error if query returns nothing due to policy.\n\n  const { data, error } = await supabase\n    .from(\"items\")\n    .select(`\n      *,\n      category:categories(name)\n    `)\n    .order(\"name\");\n\n  if (error) {\n    console.error(\"Error fetching items:\", error);\n    throw new Error(\"Failed to fetch items\");\n  }\n\n  return data as Item[];\n}\n\nexport async function createItem(input: CreateItemInput) {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  if (!user) {\n    return { error: \"Unauthorized\" };\n  }\n\n  // Get Store ID (Strict Check)\n  const { data: userRole } = await supabase\n    .from(\"user_roles\")\n    .select(\"store_id\")\n    .eq(\"user_id\", user.id)\n    .single();\n\n  if (!userRole?.store_id) {\n    return { error: \"Store not found for user\" };\n  }\n\n  const { data, error } = await supabase\n    .from(\"items\")\n    .insert({\n      store_id: userRole.store_id,\n      name: input.name,\n      code: input.code,\n      type: input.type,\n      base_unit: input.base_unit,\n      safety_stock: input.safety_stock, // Supabase handles number -> decimal\n      category_id: input.category_id,\n      is_active: true,\n    })\n    .select()\n    .single();\n\n  if (error) {\n    console.error(\"Error creating item:\", error);\n    return { error: `Failed to create item: ${error.message}` };\n  }\n\n  revalidatePath(\"/dashboard/items\");\n  return { success: true, item: data };\n}\n\nexport async function deleteItem(itemId: string) {\n  const supabase = await createClient();\n  \n  const { error } = await supabase\n    .from(\"items\")\n    .delete()\n    .eq(\"id\", itemId);\n\n  if (error) {\n    return { error: error.message };\n  }\n\n  revalidatePath(\"/dashboard/items\");\n  return { success: true };\n}"],"names":[],"mappings":";;;;;;;;;AAEA;AAEA;;;;;AAWO,eAAe;IACpB,MAAM,WAAW,MAAM,IAAA,gJAAY;IACnC,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAE/B,IAAI,CAAC,MAAM;QACT,MAAM,IAAI,MAAM;IAClB;IAEA,qEAAqE;IACrE,8EAA8E;IAC9E,iEAAiE;IACjE,wFAAwF;IACxF,oFAAoF;IAEpF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,SACL,MAAM,CAAC,CAAC;;;IAGT,CAAC,EACA,KAAK,CAAC;IAET,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO;AACT;AAEO,eAAe,WAAW,KAAsB;IACrD,MAAM,WAAW,MAAM,IAAA,gJAAY;IACnC,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAE/B,IAAI,CAAC,MAAM;QACT,OAAO;YAAE,OAAO;QAAe;IACjC;IAEA,8BAA8B;IAC9B,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,cACL,MAAM,CAAC,YACP,EAAE,CAAC,WAAW,KAAK,EAAE,EACrB,MAAM;IAET,IAAI,CAAC,UAAU,UAAU;QACvB,OAAO;YAAE,OAAO;QAA2B;IAC7C;IAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,SACL,MAAM,CAAC;QACN,UAAU,SAAS,QAAQ;QAC3B,MAAM,MAAM,IAAI;QAChB,MAAM,MAAM,IAAI;QAChB,MAAM,MAAM,IAAI;QAChB,WAAW,MAAM,SAAS;QAC1B,cAAc,MAAM,YAAY;QAChC,aAAa,MAAM,WAAW;QAC9B,WAAW;IACb,GACC,MAAM,GACN,MAAM;IAET,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO;YAAE,OAAO,CAAC,uBAAuB,EAAE,MAAM,OAAO,EAAE;QAAC;IAC5D;IAEA,IAAA,+IAAc,EAAC;IACf,OAAO;QAAE,SAAS;QAAM,MAAM;IAAK;AACrC;AAEO,eAAe,WAAW,MAAc;IAC7C,MAAM,WAAW,MAAM,IAAA,gJAAY;IAEnC,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,SACL,MAAM,GACN,EAAE,CAAC,MAAM;IAEZ,IAAI,OAAO;QACT,OAAO;YAAE,OAAO,MAAM,OAAO;QAAC;IAChC;IAEA,IAAA,+IAAc,EAAC;IACf,OAAO;QAAE,SAAS;IAAK;AACzB;;;IA3FsB;IAgCA;IA6CA;;AA7EA,+OAAA;AAgCA,+OAAA;AA6CA,+OAAA"}},
    {"offset": {"line": 293, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Proj/cafe-bakery-saas/.next-internal/server/app/dashboard/inventory/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getInventory as '00242ed99168f557f2d608515fd4bc4d8d5a963d36'} from 'ACTIONS_MODULE0'\nexport {getSuppliers as '009f2ebd9f5e18aad71d29da313f09fed9ae95f989'} from 'ACTIONS_MODULE0'\nexport {processInbound as '600976a9b4d8df6da1d5db027a73855bb18c382110'} from 'ACTIONS_MODULE0'\nexport {getItems as '001aea836daf26be9195c23c5625652d6dbba4322f'} from 'ACTIONS_MODULE1'\nexport {deleteItem as '402f3cfe50d32bb556d90c95dc56e19679ab92f2c2'} from 'ACTIONS_MODULE1'\nexport {createItem as '40e564b33b2354f68726dd75c1c6eb83c39fdb0f17'} from 'ACTIONS_MODULE1'\nexport {processInbound as '600976a9b4d8df6da1d5db027a73855bb18c382110'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA;AAGA"}}]
}