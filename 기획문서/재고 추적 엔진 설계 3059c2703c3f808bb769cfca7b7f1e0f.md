# ì¬ê³  ì¶”ì  ì—”ì§„ ì„¤ê³„

## ëª©ì°¨

1. [ì¬ê³  ê´€ë¦¬ ì² í•™](https://claude.ai/chat/fadf1908-5a16-4df3-b390-ee6d40ea1017#1-%EC%9E%AC%EA%B3%A0-%EA%B4%80%EB%A6%AC-%EC%B2%A0%ED%95%99)
2. [í•µì‹¬ í…Œì´ë¸” êµ¬ì¡°](https://claude.ai/chat/fadf1908-5a16-4df3-b390-ee6d40ea1017#2-%ED%95%B5%EC%8B%AC-%ED%85%8C%EC%9D%B4%EB%B8%94-%EA%B5%AC%EC%A1%B0)
3. [ì‹¤ì‹œê°„ ì¬ê³  ì°¨ê° ë¡œì§](https://claude.ai/chat/fadf1908-5a16-4df3-b390-ee6d40ea1017#3-%EC%8B%A4%EC%8B%9C%EA%B0%84-%EC%9E%AC%EA%B3%A0-%EC%B0%A8%EA%B0%90-%EB%A1%9C%EC%A7%81)
4. [ì¬ê³  ì‹¤ì‚¬ ì‹œìŠ¤í…œ](https://claude.ai/chat/fadf1908-5a16-4df3-b390-ee6d40ea1017#4-%EC%9E%AC%EA%B3%A0-%EC%8B%A4%EC%82%AC-%EC%8B%9C%EC%8A%A4%ED%85%9C)
5. [ì„ ì…ì„ ì¶œ(FIFO) ì²˜ë¦¬](https://claude.ai/chat/fadf1908-5a16-4df3-b390-ee6d40ea1017#5-%EC%84%A0%EC%9E%85%EC%84%A0%EC%B6%9Cfifo-%EC%B2%98%EB%A6%AC)
6. [ì¬ê³  ì¡°ì • ë° íê¸°](https://claude.ai/chat/fadf1908-5a16-4df3-b390-ee6d40ea1017#6-%EC%9E%AC%EA%B3%A0-%EC%A1%B0%EC%A0%95-%EB%B0%8F-%ED%8F%90%EA%B8%B0)
7. [ì•Œë¦¼ ë° ìë™í™”](https://claude.ai/chat/fadf1908-5a16-4df3-b390-ee6d40ea1017#7-%EC%95%8C%EB%A6%BC-%EB%B0%8F-%EC%9E%90%EB%8F%99%ED%99%94)
8. [API ì—”ë“œí¬ì¸íŠ¸ ì„¤ê³„](https://claude.ai/chat/fadf1908-5a16-4df3-b390-ee6d40ea1017#8-api-%EC%97%94%EB%93%9C%ED%8F%AC%EC%9D%B8%ED%8A%B8-%EC%84%A4%EA%B3%84)

---

## 1. ì¬ê³  ê´€ë¦¬ ì² í•™

### 1.1 BSMì˜ í˜„ì‹¤ì  ì ‘ê·¼ ë°©ì‹

ë¬¸ì„œì—ì„œ ì œì‹œí•œ ìš´ì˜ ì² í•™:

> "ì›ìì¬ ì¶”ì  ì¤‘ì‹¬ ê´€ë¦¬ â†’ í˜„ì¥ ì ìš©ì„± ë‚®ìŒ"
"POS ë°ì´í„°ëŠ” ì‹¤ì œ íŒë§¤ ê¸°ì¤€ì´ë¯€ë¡œ ë°ì´í„° ì‹ ë¢°ë„ ë†’ìŒ"
> 

### 1.2 ì´ì¤‘ ì¶”ì  ì‹œìŠ¤í…œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ì´ë¡  ì¬ê³  (Theoretical)       â”‚
â”‚   - BOM ê¸°ë°˜ ìë™ ê³„ì‚°           â”‚
â”‚   - íŒë§¤ëŸ‰ Ã— ë ˆì‹œí”¼ = ì†Œì§„ëŸ‰     â”‚
â”‚   - ì‹œìŠ¤í…œì´ ìë™ ê´€ë¦¬           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†• ì°¨ì´ ë¶„ì„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ì‹¤ì‚¬ ì¬ê³  (Physical)          â”‚
â”‚   - í˜„ì¥ ì§ì›ì´ ì§ì ‘ í™•ì¸        â”‚
â”‚   - ì£¼ 1íšŒ ë˜ëŠ” ì›” 1íšŒ           â”‚
â”‚   - ëª¨ë°”ì¼ë¡œ ê°„í¸ ì…ë ¥           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ì„¤ê³„ ëª©í‘œ

- âœ… **íŒë§¤ ì¦‰ì‹œ ìë™ ì°¨ê°** (BOM ê¸°ë°˜)
- âœ… **ì‹¤ì‚¬ ê°„í¸í™”** (ëª¨ë°”ì¼ ìµœì í™”)
- âœ… **ë¡œìŠ¤ ê°€ì‹œí™”** (ì´ë¡  vs ì‹¤ì œ)
- âœ… **ìœ í†µê¸°í•œ ì¶”ì ** (FIFO)
- âœ… **ì•ˆì „ì¬ê³  ì•Œë¦¼** (í’ˆì ˆ ë°©ì§€)

---

## 2. í•µì‹¬ í…Œì´ë¸” êµ¬ì¡°

### 2.1 Inventory (í˜„ì¬ ì¬ê³ )

ê° í’ˆëª©ì˜ ì‹¤ì‹œê°„ ì¬ê³  í˜„í™©

```sql
CREATE TABLE inventory (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  item_id UUID NOT NULL REFERENCES items(id) ON DELETE CASCADE,

  -- ì¬ê³  ìˆ˜ëŸ‰
  theoretical_quantity DECIMAL(10, 3) DEFAULT 0, -- ì´ë¡  ì¬ê³  (ì‹œìŠ¤í…œ ê³„ì‚°)
  physical_quantity DECIMAL(10, 3), -- ì‹¤ì‚¬ ì¬ê³  (ì‹¤ì œ í™•ì¸)

  -- ì°¨ì´ ë¶„ì„
  variance DECIMAL(10, 3) GENERATED ALWAYS AS
    (physical_quantity - theoretical_quantity) STORED,
  variance_percent DECIMAL(5, 2),

  -- ë©”íƒ€ë°ì´í„°
  last_physical_count_at TIMESTAMP, -- ë§ˆì§€ë§‰ ì‹¤ì‚¬ ì¼ì‹œ
  last_updated_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(store_id, item_id)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_inventory_store ON inventory(store_id);
CREATE INDEX idx_inventory_item ON inventory(item_id);
CREATE INDEX idx_inventory_low_stock ON inventory(store_id)
  WHERE theoretical_quantity < (SELECT safety_stock FROM items WHERE id = item_id);

-- ì˜ˆì‹œ ë°ì´í„°
/*
ë°•ë ¥ë¶„:
- theoretical_quantity: 15.5 kg (ì‹œìŠ¤í…œ ê³„ì‚°)
- physical_quantity: 15.0 kg (ì‹¤ì œ í™•ì¸)
- variance: -0.5 kg (ë¡œìŠ¤)
*/
```

### 2.2 Inventory_Transactions (ì¬ê³  ì´ë™ ë‚´ì—­)

ëª¨ë“  ì¬ê³  ë³€ë™ ì´ë ¥ (ì…ê³ , ì¶œê³ , ì¡°ì •, íê¸°)

```sql
CREATE TYPE transaction_type AS ENUM (
  'purchase',      -- ì…ê³ 
  'sale',          -- íŒë§¤ ì¶œê³ 
  'adjustment',    -- ì¡°ì • (ì‹¤ì‚¬ í›„)
  'waste',         -- íê¸°
  'production',    -- ìƒì‚° (ë°˜ì œí’ˆ â†’ ì™„ì œí’ˆ)
  'transfer'       -- ë§¤ì¥ ê°„ ì´ë™
);

CREATE TABLE inventory_transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  item_id UUID NOT NULL REFERENCES items(id) ON DELETE CASCADE,

  -- ê±°ë˜ ì •ë³´
  transaction_type transaction_type NOT NULL,
  quantity DECIMAL(10, 3) NOT NULL, -- ì–‘ìˆ˜: ì…ê³ , ìŒìˆ˜: ì¶œê³ 
  unit unit_type NOT NULL,

  -- ì°¸ì¡° ì •ë³´
  reference_type VARCHAR(50), -- 'sale', 'purchase_order', 'physical_count'
  reference_id UUID, -- ì—°ê²°ëœ sale_id, purchase_order_id ë“±

  -- ë¹„ìš© ì •ë³´
  unit_cost DECIMAL(10, 2), -- ë‹¨ê°€
  total_cost DECIMAL(10, 2), -- ì´ì•¡

  -- ë©”íƒ€ë°ì´í„°
  notes TEXT,
  transaction_date DATE NOT NULL,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_inv_trans_store ON inventory_transactions(store_id);
CREATE INDEX idx_inv_trans_item ON inventory_transactions(item_id);
CREATE INDEX idx_inv_trans_date ON inventory_transactions(transaction_date DESC);
CREATE INDEX idx_inv_trans_type ON inventory_transactions(transaction_type);

-- ì˜ˆì‹œ ë°ì´í„°
/*
2025-02-11:
- transaction_type: 'purchase', item: 'ë°•ë ¥ë¶„', quantity: 20, unit: 'kg', unit_cost: 5000
- transaction_type: 'sale', item: 'ë°•ë ¥ë¶„', quantity: -2.5, unit: 'kg' (í¬ë¡œì™€ìƒ 50ê°œ íŒë§¤)
*/
```

### 2.3 Purchase_Orders (ë°œì£¼/ì…ê³  ê´€ë¦¬)

ê±°ë˜ì²˜ë¡œë¶€í„°ì˜ ì…ê³  ê¸°ë¡

```sql
CREATE TYPE po_status AS ENUM ('draft', 'ordered', 'received', 'cancelled');

CREATE TABLE purchase_orders (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,

  -- ë°œì£¼ ì •ë³´
  po_number VARCHAR(50) UNIQUE, -- ë°œì£¼ ë²ˆí˜¸
  supplier_id UUID REFERENCES suppliers(id),

  -- ìƒíƒœ
  status po_status DEFAULT 'draft',

  -- ì¼ì •
  order_date DATE,
  expected_delivery_date DATE,
  received_date DATE,

  -- ê¸ˆì•¡
  total_amount DECIMAL(10, 2),

  -- ë©”íƒ€ë°ì´í„°
  notes TEXT,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE purchase_order_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  purchase_order_id UUID NOT NULL REFERENCES purchase_orders(id) ON DELETE CASCADE,
  item_id UUID NOT NULL REFERENCES items(id),

  -- ì£¼ë¬¸ ìˆ˜ëŸ‰
  ordered_quantity DECIMAL(10, 3) NOT NULL,
  received_quantity DECIMAL(10, 3) DEFAULT 0,
  unit unit_type NOT NULL,

  -- ê°€ê²©
  unit_price DECIMAL(10, 2),

  -- ìœ í†µê¸°í•œ
  expiry_date DATE,

  created_at TIMESTAMP DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_po_store ON purchase_orders(store_id);
CREATE INDEX idx_po_status ON purchase_orders(status);
CREATE INDEX idx_poi_po ON purchase_order_items(purchase_order_id);
```

### 2.4 Suppliers (ê±°ë˜ì²˜)

```sql
CREATE TABLE suppliers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,

  -- ê¸°ë³¸ ì •ë³´
  name VARCHAR(255) NOT NULL,
  business_number VARCHAR(20),

  -- ì—°ë½ì²˜
  contact_person VARCHAR(100),
  phone VARCHAR(20),
  email VARCHAR(255),
  address TEXT,

  -- ê±°ë˜ ì¡°ê±´
  payment_terms TEXT, -- "ì›”ë§ ê²°ì œ", "í˜„ê¸ˆ"
  delivery_days INT, -- í‰ê·  ë°°ì†¡ ì†Œìš”ì¼

  -- ë©”íƒ€ë°ì´í„°
  is_active BOOLEAN DEFAULT true,
  notes TEXT,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_suppliers_store ON suppliers(store_id);
```

### 2.5 Physical_Counts (ì‹¤ì‚¬ ê¸°ë¡)

```sql
CREATE TABLE physical_counts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,

  -- ì‹¤ì‚¬ ì •ë³´
  count_date DATE NOT NULL,
  count_type VARCHAR(50), -- 'full' (ì „ìˆ˜), 'spot' (í’ˆëª©ë³„)

  -- êµ¬ì—­ë³„ ì‹¤ì‚¬
  zone VARCHAR(100), -- 'ëƒ‰ë™ê³ ', 'ë“œë¼ì´ ìŠ¤í† ë¦¬ì§€', 'ì›Œí¬ì¸ ëƒ‰ì¥ê³ '

  -- ìƒíƒœ
  status VARCHAR(20) DEFAULT 'in_progress', -- 'in_progress', 'completed'

  -- ë‹´ë‹¹ì
  counted_by UUID REFERENCES users(id),
  verified_by UUID REFERENCES users(id),

  -- ë©”íƒ€ë°ì´í„°
  notes TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP
);

CREATE TABLE physical_count_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  physical_count_id UUID NOT NULL REFERENCES physical_counts(id) ON DELETE CASCADE,
  item_id UUID NOT NULL REFERENCES items(id),

  -- ì‹¤ì‚¬ ìˆ˜ëŸ‰
  counted_quantity DECIMAL(10, 3) NOT NULL,
  unit unit_type NOT NULL,

  -- ì‹œìŠ¤í…œ ì¬ê³  (ì‹¤ì‚¬ ì‹œì )
  system_quantity DECIMAL(10, 3),

  -- ì°¨ì´
  variance DECIMAL(10, 3) GENERATED ALWAYS AS
    (counted_quantity - system_quantity) STORED,

  -- ì¡°ì • ì‚¬ìœ 
  adjustment_reason VARCHAR(100), -- 'waste', 'theft', 'miscount', 'unknown'
  notes TEXT,

  created_at TIMESTAMP DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_pc_store ON physical_counts(store_id);
CREATE INDEX idx_pc_date ON physical_counts(count_date DESC);
CREATE INDEX idx_pci_pc ON physical_count_items(physical_count_id);
```

---

## 3. ì‹¤ì‹œê°„ ì¬ê³  ì°¨ê° ë¡œì§

### 3.1 íŒë§¤ ì‹œ ìë™ ì°¨ê° íŠ¸ë¦¬ê±°

```sql
-- Sales í…Œì´ë¸” (ê¸°ì¡´ì—ì„œ ì¶”ê°€)
CREATE TABLE sales (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  store_id UUID NOT NULL REFERENCES stores(id),

  order_number VARCHAR(100),
  channel VARCHAR(50), -- 'pos', 'baemin', 'coupang'
  total_amount DECIMAL(10, 2),

  sale_date DATE NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE sales_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  sale_id UUID NOT NULL REFERENCES sales(id) ON DELETE CASCADE,
  item_id UUID NOT NULL REFERENCES items(id),

  quantity DECIMAL(10, 3) NOT NULL,
  unit_price DECIMAL(10, 2),

  -- ì˜µì…˜ (JSON ì €ì¥)
  options JSONB, -- {"ìƒ·ì¶”ê°€": "2ìƒ·", "íœ˜í•‘": "ì¶”ê°€"}

  created_at TIMESTAMP DEFAULT NOW()
);

-- íŒë§¤ í›„ ì¬ê³  ì°¨ê° íŠ¸ë¦¬ê±°
CREATE OR REPLACE FUNCTION process_sale_inventory()
RETURNS TRIGGER AS $$
DECLARE
  v_material RECORD;
  v_option RECORD;
BEGIN
  -- 1. ê¸°ë³¸ ë ˆì‹œí”¼ ì¬ë£Œ ì°¨ê°
  FOR v_material IN
    SELECT
      m.material_id,
      m.total_quantity,
      m.unit
    FROM mv_flattened_bom m
    WHERE m.product_id = NEW.item_id
  LOOP
    -- Inventory ì—…ë°ì´íŠ¸
    UPDATE inventory
    SET
      theoretical_quantity = theoretical_quantity - (v_material.total_quantity * NEW.quantity),
      last_updated_at = NOW()
    WHERE store_id = (SELECT store_id FROM sales WHERE id = NEW.sale_id)
      AND item_id = v_material.material_id;

    -- Transaction ê¸°ë¡
    INSERT INTO inventory_transactions (
      store_id,
      item_id,
      transaction_type,
      quantity,
      unit,
      reference_type,
      reference_id,
      transaction_date
    ) VALUES (
      (SELECT store_id FROM sales WHERE id = NEW.sale_id),
      v_material.material_id,
      'sale',
      -(v_material.total_quantity * NEW.quantity),
      v_material.unit,
      'sale_item',
      NEW.id,
      (SELECT sale_date FROM sales WHERE id = NEW.sale_id)
    );
  END LOOP;

  -- 2. ì˜µì…˜ë³„ ì¶”ê°€ ì¬ë£Œ ì°¨ê°
  IF NEW.options IS NOT NULL THEN
    FOR v_option IN
      SELECT
        io.additional_ingredient_id,
        io.additional_quantity,
        io.additional_unit
      FROM item_options io,
      jsonb_each_text(NEW.options) AS opt
      WHERE io.item_id = NEW.item_id
        AND io.option_name = opt.key
        AND io.option_value = opt.value
    LOOP
      UPDATE inventory
      SET
        theoretical_quantity = theoretical_quantity - (v_option.additional_quantity * NEW.quantity),
        last_updated_at = NOW()
      WHERE store_id = (SELECT store_id FROM sales WHERE id = NEW.sale_id)
        AND item_id = v_option.additional_ingredient_id;

      INSERT INTO inventory_transactions (
        store_id,
        item_id,
        transaction_type,
        quantity,
        unit,
        reference_type,
        reference_id,
        transaction_date,
        notes
      ) VALUES (
        (SELECT store_id FROM sales WHERE id = NEW.sale_id),
        v_option.additional_ingredient_id,
        'sale',
        -(v_option.additional_quantity * NEW.quantity),
        v_option.additional_unit,
        'sale_item_option',
        NEW.id,
        (SELECT sale_date FROM sales WHERE id = NEW.sale_id),
        'Option: ' || NEW.options::TEXT
      );
    END LOOP;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_sale_inventory_deduction
  AFTER INSERT ON sales_items
  FOR EACH ROW
  EXECUTE FUNCTION process_sale_inventory();
```

### 3.2 ì…ê³  ì‹œ ì¬ê³  ì¦ê°€

```sql
-- ë°œì£¼ ì…ê³  ì™„ë£Œ ì‹œ
CREATE OR REPLACE FUNCTION process_purchase_receipt()
RETURNS TRIGGER AS $$
BEGIN
  -- Inventory ì—…ë°ì´íŠ¸
  UPDATE inventory
  SET
    theoretical_quantity = theoretical_quantity + NEW.received_quantity,
    last_updated_at = NOW()
  WHERE store_id = (SELECT store_id FROM purchase_orders WHERE id = NEW.purchase_order_id)
    AND item_id = NEW.item_id;

  -- ì¬ê³ ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
  IF NOT FOUND THEN
    INSERT INTO inventory (store_id, item_id, theoretical_quantity)
    VALUES (
      (SELECT store_id FROM purchase_orders WHERE id = NEW.purchase_order_id),
      NEW.item_id,
      NEW.received_quantity
    );
  END IF;

  -- Transaction ê¸°ë¡
  INSERT INTO inventory_transactions (
    store_id,
    item_id,
    transaction_type,
    quantity,
    unit,
    unit_cost,
    total_cost,
    reference_type,
    reference_id,
    transaction_date
  ) VALUES (
    (SELECT store_id FROM purchase_orders WHERE id = NEW.purchase_order_id),
    NEW.item_id,
    'purchase',
    NEW.received_quantity,
    NEW.unit,
    NEW.unit_price,
    NEW.received_quantity * NEW.unit_price,
    'purchase_order',
    NEW.purchase_order_id,
    (SELECT received_date FROM purchase_orders WHERE id = NEW.purchase_order_id)
  );

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_purchase_receipt_inventory
  AFTER UPDATE OF received_quantity ON purchase_order_items
  FOR EACH ROW
  WHEN (OLD.received_quantity IS DISTINCT FROM NEW.received_quantity)
  EXECUTE FUNCTION process_purchase_receipt();
```

---

## 4. ì¬ê³  ì‹¤ì‚¬ ì‹œìŠ¤í…œ

### 4.1 ëª¨ë°”ì¼ ì‹¤ì‚¬ í”Œë¡œìš°

```
1. ì‹¤ì‚¬ ì‹œì‘
   â†“
2. êµ¬ì—­ ì„ íƒ (ëƒ‰ë™ê³ , ë“œë¼ì´ ìŠ¤í† ë¦¬ì§€ ë“±)
   â†“
3. í’ˆëª©ë³„ ì‹¤ì œ ìˆ˜ëŸ‰ ì…ë ¥
   â†“
4. ì°¨ì´ ë°œìƒ ì‹œ ì‚¬ìœ  ì„ íƒ
   â†“
5. ì™„ë£Œ â†’ ì¬ê³  ì¡°ì •
```

### 4.2 ì‹¤ì‚¬ í”„ë¡œì„¸ìŠ¤ í•¨ìˆ˜

```sql
-- ì‹¤ì‚¬ ì‹œì‘
CREATE OR REPLACE FUNCTION start_physical_count(
  p_store_id UUID,
  p_count_date DATE,
  p_zone VARCHAR,
  p_user_id UUID
) RETURNS UUID AS $$
DECLARE
  v_count_id UUID;
BEGIN
  INSERT INTO physical_counts (
    store_id,
    count_date,
    count_type,
    zone,
    counted_by
  ) VALUES (
    p_store_id,
    p_count_date,
    'spot',
    p_zone,
    p_user_id
  ) RETURNING id INTO v_count_id;

  RETURN v_count_id;
END;
$$ LANGUAGE plpgsql;

-- í’ˆëª© ì‹¤ì‚¬
CREATE OR REPLACE FUNCTION record_count_item(
  p_count_id UUID,
  p_item_id UUID,
  p_counted_quantity DECIMAL,
  p_unit unit_type,
  p_notes TEXT DEFAULT NULL
) RETURNS VOID AS $$
DECLARE
  v_system_qty DECIMAL;
BEGIN
  -- í˜„ì¬ ì‹œìŠ¤í…œ ì¬ê³  ì¡°íšŒ
  SELECT theoretical_quantity INTO v_system_qty
  FROM inventory
  WHERE store_id = (SELECT store_id FROM physical_counts WHERE id = p_count_id)
    AND item_id = p_item_id;

  -- ì‹¤ì‚¬ í•­ëª© ê¸°ë¡
  INSERT INTO physical_count_items (
    physical_count_id,
    item_id,
    counted_quantity,
    unit,
    system_quantity,
    notes
  ) VALUES (
    p_count_id,
    p_item_id,
    p_counted_quantity,
    p_unit,
    COALESCE(v_system_qty, 0),
    p_notes
  );
END;
$$ LANGUAGE plpgsql;

-- ì‹¤ì‚¬ ì™„ë£Œ ë° ì¬ê³  ì¡°ì •
CREATE OR REPLACE FUNCTION complete_physical_count(p_count_id UUID)
RETURNS VOID AS $$
DECLARE
  v_item RECORD;
  v_store_id UUID;
  v_count_date DATE;
BEGIN
  -- ì‹¤ì‚¬ ì •ë³´ ì¡°íšŒ
  SELECT store_id, count_date INTO v_store_id, v_count_date
  FROM physical_counts
  WHERE id = p_count_id;

  -- ê° í’ˆëª©ë³„ ì¡°ì •
  FOR v_item IN
    SELECT
      item_id,
      counted_quantity,
      system_quantity,
      variance,
      unit
    FROM physical_count_items
    WHERE physical_count_id = p_count_id
  LOOP
    -- Inventory ì—…ë°ì´íŠ¸ (ì‹¤ì‚¬ ì¬ê³  ë°˜ì˜)
    UPDATE inventory
    SET
      physical_quantity = v_item.counted_quantity,
      theoretical_quantity = v_item.counted_quantity, -- ì‹¤ì‚¬ í›„ ë™ê¸°í™”
      last_physical_count_at = NOW(),
      last_updated_at = NOW()
    WHERE store_id = v_store_id
      AND item_id = v_item.item_id;

    -- ì°¨ì´ê°€ ìˆìœ¼ë©´ ì¡°ì • Transaction ê¸°ë¡
    IF v_item.variance != 0 THEN
      INSERT INTO inventory_transactions (
        store_id,
        item_id,
        transaction_type,
        quantity,
        unit,
        reference_type,
        reference_id,
        transaction_date,
        notes
      ) VALUES (
        v_store_id,
        v_item.item_id,
        'adjustment',
        v_item.variance,
        v_item.unit,
        'physical_count',
        p_count_id,
        v_count_date,
        'Physical count adjustment: ' ||
        'System: ' || v_item.system_quantity ||
        ', Counted: ' || v_item.counted_quantity
      );
    END IF;
  END LOOP;

  -- ì‹¤ì‚¬ ì™„ë£Œ ì²˜ë¦¬
  UPDATE physical_counts
  SET
    status = 'completed',
    completed_at = NOW()
  WHERE id = p_count_id;
END;
$$ LANGUAGE plpgsql;
```

### 4.3 ëª¨ë°”ì¼ UI ìŠ¤í™

```tsx
// app/(dashboard)/inventory/count/page.tsx
interface PhysicalCountScreen {
  zones: Array<{
    id: string
    name: string
    itemCount: number
  }>

  currentZone: {
    items: Array<{
      id: string
      name: string
      systemQuantity: number
      unit: string
      image?: string
    }>
  }

  countInput: {
    itemId: string
    countedQuantity: number
    adjustmentReason?: 'waste' | 'theft' | 'miscount' | 'unknown'
    notes?: string
  }
}

// UI í”Œë¡œìš°
1. êµ¬ì—­ ì„ íƒ ì¹´ë“œ
   - "ëƒ‰ë™ê³  (25ê°œ í’ˆëª©)"
   - "ë“œë¼ì´ ìŠ¤í† ë¦¬ì§€ (40ê°œ í’ˆëª©)"

2. í’ˆëª© ë¦¬ìŠ¤íŠ¸
   - ë°”ì½”ë“œ ìŠ¤ìº” ì§€ì› (ì˜µì…˜)
   - í° ìˆ«ì í‚¤íŒ¨ë“œ
   - ì‹œìŠ¤í…œ ì¬ê³  ì˜†ì— í‘œì‹œ (ì°¸ê³ ìš©)

3. ì°¨ì´ ë°œìƒ ì‹œ
   - ì°¨ì´ìœ¨ í•˜ì´ë¼ì´íŠ¸ (ë¹¨ê°„ìƒ‰/ë…¸ë€ìƒ‰)
   - ì‚¬ìœ  ì„ íƒ ëª¨ë‹¬
   - ì‚¬ì§„ ì²¨ë¶€ (ì˜µì…˜)

4. ì§„í–‰ë¥  í‘œì‹œ
   - "25ê°œ ì¤‘ 12ê°œ ì™„ë£Œ (48%)"
```

---

## 5. ì„ ì…ì„ ì¶œ(FIFO) ì²˜ë¦¬

### 5.1 Inventory_Lots (ë¡œíŠ¸/ë°°ì¹˜)

```sql
CREATE TABLE inventory_lots (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  item_id UUID NOT NULL REFERENCES items(id) ON DELETE CASCADE,

  -- ë¡œíŠ¸ ì •ë³´
  lot_number VARCHAR(100), -- ì œì¡° ë¡œíŠ¸ ë²ˆí˜¸

  -- ìˆ˜ëŸ‰
  quantity DECIMAL(10, 3) NOT NULL,
  remaining_quantity DECIMAL(10, 3) NOT NULL,
  unit unit_type NOT NULL,

  -- ë‚ ì§œ
  received_date DATE NOT NULL,
  expiry_date DATE,

  -- ë¹„ìš©
  unit_cost DECIMAL(10, 2),

  -- ì°¸ì¡°
  purchase_order_item_id UUID REFERENCES purchase_order_items(id),

  created_at TIMESTAMP DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_lots_store ON inventory_lots(store_id);
CREATE INDEX idx_lots_item ON inventory_lots(item_id);
CREATE INDEX idx_lots_expiry ON inventory_lots(expiry_date) WHERE expiry_date IS NOT NULL;
CREATE INDEX idx_lots_fifo ON inventory_lots(item_id, received_date);

-- ì˜ˆì‹œ ë°ì´í„°
/*
ë²„í„°:
- lot_number: 'LOT-2025-001', quantity: 20kg, remaining: 15kg,
  received_date: 2025-02-01, expiry_date: 2025-03-01
- lot_number: 'LOT-2025-002', quantity: 20kg, remaining: 20kg,
  received_date: 2025-02-10, expiry_date: 2025-03-10
*/
```

### 5.2 FIFO ì°¨ê° ë¡œì§

```sql
CREATE OR REPLACE FUNCTION consume_inventory_fifo(
  p_store_id UUID,
  p_item_id UUID,
  p_quantity DECIMAL,
  p_transaction_id UUID
) RETURNS VOID AS $$
DECLARE
  v_lot RECORD;
  v_remaining DECIMAL := p_quantity;
  v_consume DECIMAL;
BEGIN
  -- ì„ ì…ì„ ì¶œ: ì˜¤ë˜ëœ ë¡œíŠ¸ë¶€í„° ì°¨ê°
  FOR v_lot IN
    SELECT id, remaining_quantity
    FROM inventory_lots
    WHERE store_id = p_store_id
      AND item_id = p_item_id
      AND remaining_quantity > 0
    ORDER BY received_date ASC, created_at ASC
  LOOP
    EXIT WHEN v_remaining <= 0;

    -- ì´ë²ˆ ë¡œíŠ¸ì—ì„œ ì°¨ê°í•  ìˆ˜ëŸ‰
    v_consume := LEAST(v_lot.remaining_quantity, v_remaining);

    -- ë¡œíŠ¸ ìˆ˜ëŸ‰ ì°¨ê°
    UPDATE inventory_lots
    SET remaining_quantity = remaining_quantity - v_consume
    WHERE id = v_lot.id;

    -- ë‚¨ì€ ì°¨ê° ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
    v_remaining := v_remaining - v_consume;

    -- ë¡œíŠ¸ë³„ ì†Œì§„ ê¸°ë¡ (ì˜µì…˜)
    INSERT INTO lot_transactions (
      lot_id,
      transaction_id,
      quantity_consumed
    ) VALUES (
      v_lot.id,
      p_transaction_id,
      v_consume
    );
  END LOOP;

  -- ë¶€ì¡± ì‹œ ê²½ê³ 
  IF v_remaining > 0 THEN
    RAISE WARNING 'Insufficient inventory for item %. Short by: %',
      p_item_id, v_remaining;
  END IF;
END;
$$ LANGUAGE plpgsql;
```

---

## 6. ì¬ê³  ì¡°ì • ë° íê¸°

### 6.1 íê¸° ì²˜ë¦¬

```sql
CREATE OR REPLACE FUNCTION waste_inventory(
  p_store_id UUID,
  p_item_id UUID,
  p_quantity DECIMAL,
  p_reason TEXT,
  p_user_id UUID
) RETURNS VOID AS $$
BEGIN
  -- Inventory ì°¨ê°
  UPDATE inventory
  SET
    theoretical_quantity = theoretical_quantity - p_quantity,
    last_updated_at = NOW()
  WHERE store_id = p_store_id
    AND item_id = p_item_id;

  -- Transaction ê¸°ë¡
  INSERT INTO inventory_transactions (
    store_id,
    item_id,
    transaction_type,
    quantity,
    unit,
    transaction_date,
    notes,
    created_by
  ) VALUES (
    p_store_id,
    p_item_id,
    'waste',
    -p_quantity,
    (SELECT base_unit FROM items WHERE id = p_item_id),
    CURRENT_DATE,
    p_reason,
    p_user_id
  );
END;
$$ LANGUAGE plpgsql;
```

### 6.2 ìœ í†µê¸°í•œ ì„ë°• ì•Œë¦¼

```sql
-- ìœ í†µê¸°í•œ 7ì¼ ì´ë‚´ í’ˆëª© ì¡°íšŒ
CREATE OR REPLACE FUNCTION get_expiring_items(
  p_store_id UUID,
  p_days_threshold INT DEFAULT 7
) RETURNS TABLE(
  item_name VARCHAR,
  lot_number VARCHAR,
  remaining_quantity DECIMAL,
  expiry_date DATE,
  days_until_expiry INT
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    i.name,
    il.lot_number,
    il.remaining_quantity,
    il.expiry_date,
    (il.expiry_date - CURRENT_DATE)::INT
  FROM inventory_lots il
  JOIN items i ON i.id = il.item_id
  WHERE il.store_id = p_store_id
    AND il.expiry_date IS NOT NULL
    AND il.expiry_date <= CURRENT_DATE + p_days_threshold
    AND il.remaining_quantity > 0
  ORDER BY il.expiry_date ASC;
END;
$$ LANGUAGE plpgsql;
```

---

## 7. ì•Œë¦¼ ë° ìë™í™”

### 7.1 ì•ˆì „ì¬ê³  ì•Œë¦¼

```sql
-- ì•ˆì „ì¬ê³  ì´í•˜ í’ˆëª© ì¡°íšŒ
CREATE OR REPLACE FUNCTION get_low_stock_items(p_store_id UUID)
RETURNS TABLE(
  item_name VARCHAR,
  current_quantity DECIMAL,
  safety_stock DECIMAL,
  shortage DECIMAL
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    i.name,
    inv.theoretical_quantity,
    i.safety_stock,
    (i.safety_stock - inv.theoretical_quantity) AS shortage
  FROM inventory inv
  JOIN items i ON i.id = inv.item_id
  WHERE inv.store_id = p_store_id
    AND inv.theoretical_quantity < i.safety_stock
    AND i.is_inventory_managed = true
  ORDER BY shortage DESC;
END;
$$ LANGUAGE plpgsql;
```

### 7.2 ìë™ ë°œì£¼ ì œì•ˆ

```sql
CREATE OR REPLACE FUNCTION suggest_purchase_orders(
  p_store_id UUID,
  p_forecast_days INT DEFAULT 7
) RETURNS TABLE(
  item_name VARCHAR,
  current_stock DECIMAL,
  daily_avg_consumption DECIMAL,
  days_until_stockout INT,
  suggested_order_quantity DECIMAL
) AS $$
BEGIN
  RETURN QUERY
  WITH consumption AS (
    SELECT
      it.item_id,
      AVG(ABS(it.quantity)) AS avg_daily
    FROM inventory_transactions it
    WHERE it.store_id = p_store_id
      AND it.transaction_type = 'sale'
      AND it.transaction_date >= CURRENT_DATE - 30
    GROUP BY it.item_id
  )
  SELECT
    i.name,
    inv.theoretical_quantity,
    c.avg_daily,
    FLOOR(inv.theoretical_quantity / NULLIF(c.avg_daily, 0))::INT,
    GREATEST(
      i.safety_stock - inv.theoretical_quantity,
      c.avg_daily * p_forecast_days
    )
  FROM inventory inv
  JOIN items i ON i.id = inv.item_id
  LEFT JOIN consumption c ON c.item_id = inv.item_id
  WHERE inv.store_id = p_store_id
    AND inv.theoretical_quantity < i.safety_stock
  ORDER BY (inv.theoretical_quantity / NULLIF(c.avg_daily, 0)) ASC;
END;
$$ LANGUAGE plpgsql;

-- ì‹¤í–‰ ì˜ˆì‹œ
SELECT * FROM suggest_purchase_orders('ë§¤ì¥_id', 7);

-- ê²°ê³¼:
-- ì›ë‘, 1.5kg, 0.5kg/ì¼, 3ì¼, 2.0kg (ì¶”ì²œ ë°œì£¼ëŸ‰)
-- ìš°ìœ , 10L, 5L/ì¼, 2ì¼, 25L
```

### 7.3 Slack ì•Œë¦¼ í†µí•©

```tsx
// lib/notifications/inventory-alerts.ts
import { supabase } from '@/lib/supabase'

export async function sendLowStockAlert(storeId: string) {
  const { data: lowStockItems } = await supabase
    .rpc('get_low_stock_items', { p_store_id: storeId })

  if (lowStockItems && lowStockItems.length > 0) {
    const message = `âš ï¸ ì•ˆì „ì¬ê³  ì•Œë¦¼\n\n` +
      lowStockItems.map(item =>
        `â€¢ ${item.item_name}: ${item.current_quantity} (ì•ˆì „ì¬ê³ : ${item.safety_stock})`
      ).join('\n')

    await fetch(process.env.SLACK_WEBHOOK_URL!, {
      method: 'POST',
      body: JSON.stringify({ text: message })
    })
  }
}

export async function sendExpiryAlert(storeId: string) {
  const { data: expiringItems } = await supabase
    .rpc('get_expiring_items', {
      p_store_id: storeId,
      p_days_threshold: 7
    })

  if (expiringItems && expiringItems.length > 0) {
    const message = `ğŸ“… ìœ í†µê¸°í•œ ì„ë°• ì•Œë¦¼\n\n` +
      expiringItems.map(item =>
        `â€¢ ${item.item_name} (ë¡œíŠ¸: ${item.lot_number})\n` +
        `  ì”ì—¬: ${item.remaining_quantity}, ë§Œë£Œ: ${item.expiry_date} (D-${item.days_until_expiry})`
      ).join('\n')

    await fetch(process.env.SLACK_WEBHOOK_URL!, {
      method: 'POST',
      body: JSON.stringify({ text: message })
    })
  }
}
```

---

## 8. API ì—”ë“œí¬ì¸íŠ¸ ì„¤ê³„

### 8.1 ì¬ê³  ì¡°íšŒ API

```tsx
// app/api/inventory/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

export async function GET(request: NextRequest) {
  const supabase = createClient()
  const storeId = request.nextUrl.searchParams.get('store_id')

  const { data, error } = await supabase
    .from('inventory')
    .select(`
      id,
      theoretical_quantity,
      physical_quantity,
      variance,
      last_physical_count_at,
      item:items (
        id,
        name,
        code,
        base_unit,
        safety_stock,
        category:categories (name)
      )
    `)
    .eq('store_id', storeId)
    .order('variance', { ascending: true }) // ë¡œìŠ¤ í° ìˆœ

  if (error) return NextResponse.json({ error }, { status: 500 })
  return NextResponse.json(data)
}
```

### 8.2 ì‹¤ì‚¬ ì‹œì‘ API

```tsx
// app/api/inventory/count/route.ts
export async function POST(request: NextRequest) {
  const supabase = createClient()
  const body = await request.json()

  const { data, error } = await supabase
    .rpc('start_physical_count', {
      p_store_id: body.storeId,
      p_count_date: body.countDate,
      p_zone: body.zone,
      p_user_id: body.userId
    })

  if (error) return NextResponse.json({ error }, { status: 500 })
  return NextResponse.json({ countId: data })
}
```

### 8.3 ì‹¤ì‚¬ í•­ëª© ê¸°ë¡ API

```tsx
// app/api/inventory/count/[id]/items/route.ts
export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const supabase = createClient()
  const body = await request.json()

  const { error } = await supabase
    .rpc('record_count_item', {
      p_count_id: params.id,
      p_item_id: body.itemId,
      p_counted_quantity: body.countedQuantity,
      p_unit: body.unit,
      p_notes: body.notes
    })

  if (error) return NextResponse.json({ error }, { status: 500 })
  return NextResponse.json({ success: true })
}
```

### 8.4 ì‹¤ì‚¬ ì™„ë£Œ API

```tsx
// app/api/inventory/count/[id]/complete/route.ts
export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const supabase = createClient()

  const { error } = await supabase
    .rpc('complete_physical_count', {
      p_count_id: params.id
    })

  if (error) return NextResponse.json({ error }, { status: 500 })

  // ì™„ë£Œ í›„ Slack ì•Œë¦¼
  const { data: countData } = await supabase
    .from('physical_counts')
    .select('*, physical_count_items(*)')
    .eq('id', params.id)
    .single()

  const totalVariance = countData.physical_count_items.reduce(
    (sum: number, item: any) => sum + Math.abs(item.variance),
    0
  )

  await fetch(process.env.SLACK_WEBHOOK_URL!, {
    method: 'POST',
    body: JSON.stringify({
      text: `âœ… ì‹¤ì‚¬ ì™„ë£Œ\nêµ¬ì—­: ${countData.zone}\nì´ ì°¨ì´: ${totalVariance.toFixed(2)}`
    })
  })

  return NextResponse.json({ success: true })
}
```

---

## 9. ëŒ€ì‹œë³´ë“œ ìœ„ì ¯

### 9.1 ì¬ê³  í˜„í™© ì¹´ë“œ

```tsx
// components/dashboard/inventory-status.tsx
interface InventoryStatusProps {
  storeId: string
}

export function InventoryStatus({ storeId }: InventoryStatusProps) {
  const { data: lowStock } = useSWR(
    `/api/inventory/low-stock?store_id=${storeId}`,
    fetcher
  )

  const { data: expiring } = useSWR(
    `/api/inventory/expiring?store_id=${storeId}`,
    fetcher
  )

  return (
    <Card>
      <CardHeader>
        <CardTitle>ì¬ê³  ì•Œë¦¼</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {/* ì•ˆì „ì¬ê³  ì´í•˜ */}
          {lowStock && lowStock.length > 0 && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>ì•ˆì „ì¬ê³  ì´í•˜ {lowStock.length}ê°œ</AlertTitle>
              <AlertDescription>
                {lowStock.slice(0, 3).map((item: any) => (
                  <div key={item.item_name}>
                    â€¢ {item.item_name}: {item.current_quantity}
                    (ë¶€ì¡±: {item.shortage})
                  </div>
                ))}
              </AlertDescription>
            </Alert>
          )}

          {/* ìœ í†µê¸°í•œ ì„ë°• */}
          {expiring && expiring.length > 0 && (
            <Alert variant="warning">
              <Clock className="h-4 w-4" />
              <AlertTitle>ìœ í†µê¸°í•œ ì„ë°• {expiring.length}ê°œ</AlertTitle>
              <AlertDescription>
                {expiring.slice(0, 3).map((item: any) => (
                  <div key={item.lot_number}>
                    â€¢ {item.item_name}: D-{item.days_until_expiry}
                  </div>
                ))}
              </AlertDescription>
            </Alert>
          )}
        </div>
      </CardContent>
    </Card>
  )
}
```

### 9.2 ì¬ê³  ì°¨ì´ ë¶„ì„ ì°¨íŠ¸

```tsx
// components/dashboard/inventory-variance-chart.tsx
export function InventoryVarianceChart({ storeId }: { storeId: string }) {
  const { data } = useSWR(
    `/api/inventory/variance-analysis?store_id=${storeId}`,
    fetcher
  )

  return (
    <Card>
      <CardHeader>
        <CardTitle>ì¬ê³  ë¡œìŠ¤ ë¶„ì„</CardTitle>
        <CardDescription>ì´ë¡  ì¬ê³  vs ì‹¤ì‚¬ ì¬ê³ </CardDescription>
      </CardHeader>
      <CardContent>
        <ResponsiveContainer width="100%" height={300}>
          <BarChart data={data}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="item_name" />
            <YAxis />
            <Tooltip />
            <Legend />
            <Bar dataKey="theoretical_quantity" fill="#8884d8" name="ì´ë¡  ì¬ê³ " />
            <Bar dataKey="physical_quantity" fill="#82ca9d" name="ì‹¤ì‚¬ ì¬ê³ " />
          </BarChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  )
}
```

---

## 10. ì„±ëŠ¥ ìµœì í™”

### 10.1 ì¸ë±ìŠ¤ ì „ëµ

```sql
-- ìì£¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ ìµœì í™”
CREATE INDEX idx_inv_trans_store_date_type
  ON inventory_transactions(store_id, transaction_date DESC, transaction_type);

-- ì¬ê³  ë¶€ì¡± í’ˆëª© ë¹ ë¥¸ ì¡°íšŒ
CREATE INDEX idx_inventory_low_stock_filtered
  ON inventory(store_id, item_id)
  WHERE theoretical_quantity < (SELECT safety_stock FROM items WHERE id = item_id);

-- FIFO ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_lots_fifo_composite
  ON inventory_lots(store_id, item_id, received_date)
  WHERE remaining_quantity > 0;
```

### 10.2 ë°°ì¹˜ ì²˜ë¦¬

```sql
-- ëŒ€ëŸ‰ íŒë§¤ ì‹œ ì¬ê³  ì°¨ê° ìµœì í™”
CREATE OR REPLACE FUNCTION batch_deduct_inventory(
  p_sale_items JSON
) RETURNS VOID AS $$
BEGIN
  -- ì„ì‹œ í…Œì´ë¸”ì— ë°ì´í„° ì ì¬
  CREATE TEMP TABLE temp_deductions AS
  SELECT
    (item->>'item_id')::UUID AS item_id,
    (item->>'quantity')::DECIMAL AS quantity
  FROM json_array_elements(p_sale_items) AS item;

  -- ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ì¼ê´„ ì—…ë°ì´íŠ¸
  UPDATE inventory inv
  SET
    theoretical_quantity = theoretical_quantity - td.quantity,
    last_updated_at = NOW()
  FROM temp_deductions td
  WHERE inv.item_id = td.item_id;

  DROP TABLE temp_deductions;
END;
$$ LANGUAGE plpgsql;
```

---

## 11. ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 5ì£¼ì°¨ ëª©í‘œ

- [ ]  inventory í…Œì´ë¸” ìƒì„±
- [ ]  inventory_transactions í…Œì´ë¸” ìƒì„±
- [ ]  purchase_orders, purchase_order_items í…Œì´ë¸” ìƒì„±
- [ ]  suppliers í…Œì´ë¸” ìƒì„±
- [ ]  physical_counts, physical_count_items í…Œì´ë¸” ìƒì„±
- [ ]  inventory_lots í…Œì´ë¸” ìƒì„± (FIFO)

### íŠ¸ë¦¬ê±° ë° í•¨ìˆ˜

- [ ]  process_sale_inventory() íŠ¸ë¦¬ê±° ìƒì„±
- [ ]  process_purchase_receipt() íŠ¸ë¦¬ê±° ìƒì„±
- [ ]  start_physical_count() í•¨ìˆ˜
- [ ]  record_count_item() í•¨ìˆ˜
- [ ]  complete_physical_count() í•¨ìˆ˜
- [ ]  get_low_stock_items() í•¨ìˆ˜
- [ ]  get_expiring_items() í•¨ìˆ˜

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

- [ ]  íŒë§¤ â†’ ì¬ê³  ìë™ ì°¨ê° í™•ì¸
- [ ]  ì…ê³  â†’ ì¬ê³  ì¦ê°€ í™•ì¸
- [ ]  ì‹¤ì‚¬ â†’ ì¬ê³  ì¡°ì • í™•ì¸
- [ ]  FIFO ë¡œì§ ê²€ì¦
- [ ]  ì•ˆì „ì¬ê³  ì•Œë¦¼ í…ŒìŠ¤íŠ¸

---

## 12. ì‹¤ì „ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: í•˜ë£¨ ìš´ì˜ í”Œë¡œìš°

```
06:00 - ë°œì£¼ ë„ì°©
  â†’ ì ì¥ì´ ëª¨ë°”ì¼ë¡œ ì…ê³  ì²˜ë¦¬
  â†’ ê° í’ˆëª©ë³„ ìˆ˜ëŸ‰ ì…ë ¥
  â†’ ìœ í†µê¸°í•œ ì…ë ¥
  â†’ ì¬ê³  ìë™ ì¦ê°€

09:00 - ì˜ì—… ì‹œì‘
  â†’ POS/ë°°ë¯¼ ì£¼ë¬¸ ë°œìƒ
  â†’ íŒë§¤ ë°ì´í„° ìë™ ìˆ˜ì§‘
  â†’ BOM ê¸°ë°˜ ì¬ê³  ìë™ ì°¨ê°

15:00 - ì•ˆì „ì¬ê³  ì•Œë¦¼
  â†’ ì›ë‘ ì¬ê³  ì•ˆì „ì¬ê³  ì´í•˜ ê°ì§€
  â†’ Slack ì•Œë¦¼ ë°œì†¡
  â†’ ì ì¥ì´ ë°œì£¼ ì§„í–‰

22:00 - ì˜ì—… ì¢…ë£Œ
  â†’ ì¼ì¼ ì¬ê³  í˜„í™© ë¦¬í¬íŠ¸ ìë™ ì „ì†¡
  â†’ ë¡œìŠ¤ìœ¨ í™•ì¸
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ì£¼ê°„ ì‹¤ì‚¬

```
ì›”ìš”ì¼ ì˜¤ì „:
1. ì ì¥ì´ ëª¨ë°”ì¼ì—ì„œ "ì‹¤ì‚¬ ì‹œì‘" í´ë¦­
2. êµ¬ì—­ ì„ íƒ: "ëƒ‰ë™ê³ "
3. í’ˆëª©ë³„ ì‹¤ì œ ìˆ˜ëŸ‰ ì…ë ¥
   - ë°•ë ¥ë¶„: ì‹œìŠ¤í…œ 15.5kg, ì‹¤ì œ 15.0kg
   - ë²„í„°: ì‹œìŠ¤í…œ 10kg, ì‹¤ì œ 9.5kg
4. ì°¨ì´ ë°œìƒ ì‹œ ì‚¬ìœ  ì„ íƒ
   - ë°•ë ¥ë¶„: "íê¸°" (ìœ í†µê¸°í•œ ì„ë°•)
   - ë²„í„°: "ì›ì¸ë¶ˆëª…"
5. "ì™„ë£Œ" í´ë¦­
6. ì‹œìŠ¤í…œì´ ì¬ê³  ì¡°ì •
7. Slack ì•Œë¦¼: "ì‹¤ì‚¬ ì™„ë£Œ, ì´ ì°¨ì´ 1kg"
```

---

## ê²°ë¡ 

ì´ ì¬ê³  ì¶”ì  ì—”ì§„ì€:

- âœ… **ì™„ì „ ìë™í™”**: íŒë§¤ ì¦‰ì‹œ BOM ê¸°ë°˜ ì°¨ê°
- âœ… **í˜„ì‹¤ì  ì ‘ê·¼**: ì´ë¡  ì¬ê³  + ì‹¤ì‚¬ ì¬ê³  ì´ì¤‘ ì¶”ì 
- âœ… **ëª¨ë°”ì¼ ìµœì í™”**: í˜„ì¥ ì§ì›ì´ ì‰½ê²Œ ì‚¬ìš©
- âœ… **FIFO ì§€ì›**: ìœ í†µê¸°í•œ ê´€ë¦¬ ì™„ë²½ ëŒ€ì‘
- âœ… **ìŠ¤ë§ˆíŠ¸ ì•Œë¦¼**: ì•ˆì „ì¬ê³ , ìœ í†µê¸°í•œ ìë™ ì•Œë¦¼

ë‹¤ìŒ ë‹¨ê³„ëŠ” **ì…ê³  ê´€ë¦¬ UI ë° ëª¨ë°”ì¼ ì‹¤ì‚¬ í™”ë©´ êµ¬í˜„**ì…ë‹ˆë‹¤!